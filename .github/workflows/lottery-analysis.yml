name: Lottery Analysis and Notification

on:
  schedule:
    # 北京时间中午12:00运行（UTC时间04:00）
    # 双色球：周二、四、日（开奖当天）
    - cron: '0 4 * * 2,4,0'
    # 大乐透：周一、三、六（开奖当天）
    - cron: '0 4 * * 1,3,6'
  workflow_dispatch:
    inputs:
      lottery_type:
        description: '彩票类型'
        required: true
        default: 'ssq'
        type: choice
        options:
        - ssq
        - dlt
      test_mode:
        description: '测试模式（不发送实际消息）'
        required: false
        default: false
        type: boolean

env:
  PYTHON_VERSION: '3.11'
  PIP_CACHE_DIR: ~/.cache/pip

jobs:
  analyze-and-notify:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
        cache-dependency-path: 'requirements.txt'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install --no-cache-dir -r requirements.txt
        
    - name: Create directories
      run: |
        mkdir -p data/cache/ssq
        mkdir -p data/cache/dlt
        mkdir -p logs
        
    - name: Determine lottery type
      id: lottery
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "lottery_type=${{ github.event.inputs.lottery_type }}" >> $GITHUB_OUTPUT
          echo "test_mode=${{ github.event.inputs.test_mode || 'false' }}" >> $GITHUB_OUTPUT
        else
          # 根据当前日期判断彩票类型
          DAY=$(date -u +%u)  # 1=周一, 2=周二, ..., 7=周日
          if [ "$DAY" = "1" ] || [ "$DAY" = "3" ] || [ "$DAY" = "6" ]; then
            echo "lottery_type=dlt" >> $GITHUB_OUTPUT
          else
            echo "lottery_type=ssq" >> $GITHUB_OUTPUT
          fi
          echo "test_mode=false" >> $GITHUB_OUTPUT
        fi
        echo "今日彩票类型: ${{ steps.lottery.outputs.lottery_type }}"
        
    - name: Run lottery analysis
      env:
        PYTHONPATH: ${{ github.workspace }}
        WECHAT_WEBHOOK_URL: ${{ secrets.WECHAT_WEBHOOK_URL }}
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
      run: |
        echo "开始运行 ${{ steps.lottery.outputs.lottery_type }} 分析..."
        if [ "${{ steps.lottery.outputs.test_mode }}" = "true" ]; then
          python src/main.py --lottery ${{ steps.lottery.outputs.lottery_type }} --test
        else
          python src/main.py --lottery ${{ steps.lottery.outputs.lottery_type }}
        fi
        
    - name: Upload cache data
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: cache-data-${{ steps.lottery.outputs.lottery_type }}
        path: data/cache/
        retention-days: 30
        
    - name: Upload logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: analysis-logs-${{ steps.lottery.outputs.lottery_type }}
        path: logs/
        retention-days: 7
        
    - name: Notify on failure
      if: failure() && steps.lottery.outputs.test_mode != 'true'
      run: |
        echo "分析任务失败，请检查日志"
        # 可选：发送失败通知
        
  # 手动触发时可以同时分析两种彩票
  analyze-all:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    if: github.event_name == 'workflow_dispatch'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
        cache-dependency-path: 'requirements.txt'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install --no-cache-dir -r requirements.txt
        
    - name: Create directories
      run: |
        mkdir -p data/cache/ssq
        mkdir -p data/cache/dlt
        mkdir -p logs
        
    - name: Run SSQ analysis
      env:
        PYTHONPATH: ${{ github.workspace }}
        WECHAT_WEBHOOK_URL: ${{ secrets.WECHAT_WEBHOOK_URL }}
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
      run: |
        echo "开始运行双色球分析..."
        python src/main.py --lottery ssq
        
    - name: Run DLT analysis
      env:
        PYTHONPATH: ${{ github.workspace }}
        WECHAT_WEBHOOK_URL: ${{ secrets.WECHAT_WEBHOOK_URL }}
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
      run: |
        echo "开始运行大乐透分析..."
        python src/main.py --lottery dlt
        
    - name: Upload logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: all-analysis-logs
        path: logs/
        retention-days: 7
